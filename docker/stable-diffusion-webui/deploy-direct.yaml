version: '3'

services:
  sd-webui:
    image: sd-webui:${TAG}
    container_name: sd-webui_${APP_ENV}
    restart: always
    user: ${UserID}:${GroupID}
    networks: ["net"]
    # ports: ["127.0.0.1:7860:7860"]
    ports: ["7860:7860"]
    environment: ["TZ=Asia/Shanghai"]
    deploy:
      resources:
        # limits: { cpus: "4", memory: 15g }
        reservations:
          # cpus: "1"
          # memory: 4g
          devices:
          - driver: nvidia
            # device_ids: ['0', '3']
            # count: 1
            count: all
            capabilities: [gpu]
    volumes:
    - ./data/outputs:/app/sd-webui/outputs
    - ./data/models:/app/sd-webui/models
    # - ./data/extentions/sd-webui-controlnet:/app/sd-webui/extensions/sd-webui-controlnet/annotator/downloads
    ## hed, lineart_anime, mlsd, pidinet
    # - ./data/cache:/root/.cache
    # - ./data/interrogate:/app/sd-webui/interrogate
    command:
    - /app/bin/entrypoint.sh
    - --xformers
    - --listen
    - --api
    - --port=7860
    # - --ckpt=models/Stable-diffusion/realisticVisionV13_v13.safetensors

networks:
  net:
    name: sd-webui_${APP_ENV}
    driver: bridge
    external: false
