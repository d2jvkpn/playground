# $ htpasswd /etc/nginx/ollama.hello.htpasswd hello
# username1:encrypted_password1
# username2:encrypted_password2
# username3:encrypted_password3
server {
    listen 8000;
    server_name api.localhost;

    location / {
        auth_basic "Ollama API";
        auth_basic_user_file /etc/nginx/ollama.hello.htpasswd;

        proxy_pass http://localhost:11434;
        proxy_set_header Host $host;
    }
}

server {
    listen 80;
    server_name web.localhost;

    location / {
        if ($http_x_api_key != "your_secret_key_123") {
            return 403;
        }

        if ($http_authorization != "Bearer YOUR_TOKEN_HERE") {
            return 401;
        }

        if ($http_authorization !~* ^Bearer\s+(token1|token2|token3)$) {
            return 401;
        }

        proxy_pass http://localhost:11434;
        proxy_set_header Host $host;
    }
}

http {
    log_format custom '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'trace_id="$upstream_http_x_backend_trace_id"';

    access_log /var/log/nginx/access.log custom;

    server {
        listen 80;
        server_name example.com;

        location / {
            proxy_pass http://backend;

            # 1. 把后端 header X-Backend-Trace-ID 捕获为变量, 并写入 $upstream_http_x_backend_trace_id
            # 2. 从响应中移除该 Header
            proxy_hide_header X-Backend-Trace-ID;
        }
    }
}
