FROM pytorch/pytorch:2.8.0-cuda12.9-cudnn9-runtime

#### 1. installation
COPY apps /opt/apps
ADD compose.jupyter.yaml run.sh Containerfile /opt/
RUN chmod a+x /opt/apps/*.sh

RUN /opt/apps/apt_install.sh \
    tzdata build-essential gosu vim file \
    jq tree dos2unix git openssh-client curl

RUN conda install cuda-nvcc -c nvidia

RUN pip install --no-cache-dir -U -r /opt/apps/pip.txt
# -i https://pypi.tuna.tsinghua.edu.cn/simple

#### 2. config
RUN mkdir -p /home/appuser/workspace /home/appuser/.jupyter && \
  cp /opt/apps/jupyter_lab_config.py /home/appuser/.jupyter/

RUN userdel -r ubuntu || true

#### 3. define
# default=/workspace
WORKDIR /home/appuser/workspace

#USER appuser
EXPOSE 8888

VOLUME ["/home/appuser/workspace", "/home/appuser/.local/lib/python3.11/site-packages"]

ENV TZ=Asia/Shanghai

ENTRYPOINT ["/opt/apps/entrypoint.sh"]

#### 4. run
# "--NotebookApp.token=''", "--NotebookApp.password=''"
CMD ["jupyter", "lab", "--no-browser", "--allow-root", "--ip=0.0.0.0", "--port=8888"]
