#FROM pytorch/pytorch:2.8.0-cuda12.9-cudnn9-runtime
#FROM local/pytorch:2.9.0-cuda13.0-cudnn9-runtime
FROM local/pytorch:2.8.0-cuda12.9-cudnn9-runtime

#### 1. installation
COPY install /opt/install
ADD compose.jupyter.yaml Containerfile /opt/
RUN chmod a+x /opt/install/*.sh

RUN /opt/install/apt_install.sh tzdata gosu build-essential \
  vim dos2unix git jq curl file tree
# openssh-client nvidia-cuda-toolkit

RUN conda install cuda-nvcc -c nvidia && pip install --no-cache-dir flash-attn

RUN pip install --no-cache-dir -U -r /opt/install/pip.txt
# -i https://pypi.tuna.tsinghua.edu.cn/simple

#### 2. config
RUN userdel -r ubuntu || true && \
  mkdir -p /home/appuser/workspace /home/appuser/.jupyter && \
  cp /opt/install/jupyter_lab_config.py /home/appuser/.jupyter/

#### 3. define
# WORKDIR /workspace
WORKDIR /home/appuser/workspace

#RUN useradd -m -s /bin/bash -u 1000 -g 1000 appuser
#USER appuser

EXPOSE 8888

VOLUME ["/home/appuser/workspace", "/home/appuser/.local/lib/python3.12/site-packages"]

ENTRYPOINT ["/opt/install/entrypoint.sh"]

ENV TZ=Asia/Shanghai


#### 4. run
# "--NotebookApp.token=''", "--NotebookApp.password=''"
CMD ["jupyter", "lab", "--no-browser", "--allow-root", "--ip=0.0.0.0", "--port=8888"]
