FROM alpine:3

ARG http_proxy
ARG https_proxy
ARG no_proxy

ENV http_proxy=$http_proxy \
    https_proxy=$https_proxy \
    no_proxy=$no_proxy

ARG TARGET_OS=linux
ARG TARGET_ARCH=amd64

RUN apk --no-cache update && \
    apk --no-cache upgrade && \
    apk add --no-cache tzdata supervisor gosu ca-certificates curl bash && \
    update-ca-certificates

RUN set -eux; \
    arch="${TARGET_ARCH}"; \
    case "$arch" in \
      amd64) bin="hysteria-linux-amd64" ;; \
      arm64) bin="hysteria-linux-arm64" ;; \
      *) echo "Unsupported arch: ${TARGET_ARCH}" && exit 1 ;; \
    esac; \
    url="https://github.com/apernet/hysteria/releases/latest/download/${bin}"; \
    echo "Downloading: $url"; \
    mkdir -p /opt/bin; \
    curl -fsSL "$url" -o /opt/bin/hysteria; \
    chmod a+x /opt/bin/hysteria; \
    /opt/bin/hysteria version || true

# url="https://github.com/apernet/hysteria/releases/download/${HYSTERIA_VERSION}/${bin}"; \

VOLUME /home/workspace/configs
VOLUME /home/workspace/logs
ADD supervisord.conf /home/workspace/configs/

WORKDIR /home/workspace

ENV PATH=/opt/bin:$PATH \
    http_proxy="" \
    https_proxy="" \
    no_proxy="" \
    APPUSER_UID=0 \
    APPUSER_GID=0

EXPOSE 443/udp
EXPOSE 1080/tcp
EXPOSE 1081/tcp

CMD ["supervisord", "-c", "configs/supervisord.conf"]
