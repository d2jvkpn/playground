### Clone Nodes
---

#### 1. clone kvm_ubuntu
```bash
name=ubuntu22.04
# target=node01

virsh shutdown $name || true

virt-clone --original $name --name $target --file /var/lib/libvirt/images/$target.qcow2
# virt-clone --original $name --name $target --auto-clone
```

#### 2. setup node01
```bash
virsh list --all
virsh start $target || true
# don't start $name

# ip is as same as $name
# wait
virsh domifaddr $target

# wait...
addr=$(virsh domifaddr $target | awk '$1!="" && $1!~"^-"{split($NF, a, "/"); addr=a[1]} END{print addr}')
echo "~~~ host: $target, addr: $addr"

ssh-keyscan -H $addr >> ~/.ssh/known_hosts
ssh hello@$addr

# target=node01
sudo hostnamectl set-hostname $target
sudo sed -i "2s/^127.0.1.1 .*$/127.0.1.1 $target/" /etc/hosts

sudo rm /etc/machine-id
sudo dbus-uuidgen --ensure=/etc/machine-id

# rm -v /etc/ssh/ssh_host_* && dpkg-reconfigure openssh-server --default-priority

sudo shutdown now
```

#### 3. fix ip of node01

#### 4. extend disk size
```bash
vm=vm1

# virsh domblklist $vm
# qemu-img info /var/lib/libvirt/images/$vm.qcow2
# qemu-img resize /var/lib/libvirt/images/$vm.qcow2 +10G
# qemu-img info /var/lib/libvirt/images/$vm.qcow2

# Please note that qemu-img canâ€™t resize an image which has snapshots. You will need to first remove
# all VM snapshots. See this example:
# virsh snapshot-list $vm
# virsh snapshot-delete --domain $vm --snapshotname $??

ssh root@$vm
lsblk
pvs
vgdisplay
fdisk -l | grep -- "--lv"
lvextend -L +10G /dev/mapper/ubuntu--vg-ubuntu--lv
resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
```

##### 5. more vrish commands
```bash
virsh edit $VHOST

virsh setvcpus vm1 2 --config

virsh net-list --all
virsh net-dhcp-leases default

man virsh

virsh start foo
virsh reboot foo
virsh shutdown foo
virsh suspend foo
virsh resume foo

virsh console foo

virsh dumpxml foo
virsh define foo
virsh destroy foo_new
virsh undefine foo_new
```
