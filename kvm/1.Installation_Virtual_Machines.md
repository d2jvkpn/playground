### Installation Virtual Machines
---

#### 1. install kvm
```bash
grep -Eoc '(vmx|svm)' /proc/cpuinfo
sudo apt install cpu-checker

cpu-checker
# 

sudo apt install qemu-system-x86 libvirt-daemon-system libvirt-clients bridge-utils virtinst virt-manager

systemctl is-active libvirtd
usermod -aG libvirt $USER
usermod -aG kvm $USER
brctl show
```

#### 2. create virtual machine
```bash
name=ubuntu

virt-install --name=$name --os-variant=generic --vcpus=2 --memory=2048 \
  --disk path=/var/lib/libvirt/images/$name.qcow2,size=30              \
  --cdrom=~/kvm/ubuntu-22.04.1-live-server-amd64.iso
```

#### 3. ubuntu installation UI
...username: hello
```bash
hostnamectl hostname kvm
sed -i '/127.0.1.1/s/ .*/ kvm/' /etc/hosts
```


#### 4. ssh virtual machine
```bash
name=ubuntu

virsh start $name
virsh net-list
virsh net-dhcp-leases default
# rm /var/lib/libvirt/dnsmasq/virbr0.*

addr=$(virsh domifaddr $name | awk '$1!=""{split($NF, a, "/"); addr=a[1]} END{print addr}')
ssh hello@$addr

# update /etc/apt/sources.list
sudo apt update && apt -y upgrade

sudo apt install -y software-properties-common apt-transport-https ca-certificates \
  vim iftop iotop net-tools gnupg-agent gnupg2 tree jq at autossh pigz        \
  iputils-ping curl file

sudo timedatectl set-timezone Asia/Shanghai

sudo apt clean && sudo apt autoclean
sudo apt remove && sudo apt autoremove

echo "hello ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/hello 
# echo -e "\n\n\nPermitRootLogin yes" >> /etc/ssh/sshd_config

systemctl restart ssh
# passwd
```

#### 5. fix ip of virtual machine
```bash
virsh start $name || true

# wait...
addr=$(virsh domifaddr $name | awk '$1!=""{split($NF, a, "/"); addr=a[1]} END{print addr}')
# mac=$(virsh dumpxml $name | xq -r '.domain.devices.interface.mac."@address"')
mac=$(virsh domiflist $name | awk 'NR==3{print $NF}')

record=$(printf "<host mac='%s' name='%s' ip='%s'/>" $mac $name $addr)
virsh net-update default add ip-dhcp-host "$record" --live --config

virsh net-dumpxml default
# virsh net-edit default
# virsh net-destroy default
# virsh net-start default
```

#### 6. ssh without password
```bash
ssh-keygen -t rsa -m PEM -b 2048 -P "" -f ~/.ssh/kvm.pem -C 'ubuntu'
chmod 0600 ~/.ssh/kvm.pem

name=ubuntu
user=hello
ssh-keyscan -H $addr >> ~/.ssh/known_hosts

cat >> ~/.ssh/config << EOF
Host $name
    HostName      $addr
    User          hello
    Port          22
    LogLevel      INFO
    Compression   yes
    IdentityFile  ~/.ssh/kvm.pem
EOF

ssh-copy-id -i ~/.ssh/kvm.pem $host
# ssh $name
```
